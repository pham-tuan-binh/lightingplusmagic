$(document).ready(function(){function t(t,a,e){return(1+e.A*Math.exp(e.B/Math.cos(t)))*(1+e.C*Math.exp(e.D*a)+e.E*Math.pow(Math.cos(a),2))}function a(t){return Math.max(Math.min(Math.pow(t,1/1.8),1),0)}function e(e,r,o,n,h,f){var i=function(t,a,e,r){return Math.acos(Math.sin(e)*Math.sin(t)*Math.cos(a-r)+Math.cos(e)*Math.cos(t))}(e,r,n,h);e=Math.min(e,Math.PI/2);var c,M,s,l,u,g=o.Yz*t(e,i,f.coeffsY)/t(0,n,f.coeffsY),d=o.xz*t(e,i,f.coeffsx)/t(0,n,f.coeffsx),v=o.yz*t(e,i,f.coeffsy)/t(0,n,f.coeffsy);return{r:a(3.2406*(l=(M=d)/(s=v)*(c=g))-1.5372*c-.4986*(u=(1-M-s)/s*c)),g:a(-.9689*l+1.8758*c+.0415*u),b:a(.0557*l-.204*c+1.057*u)}}function r(t,a,e,r,o){return(t-a)/(e-a)*(o-r)+r}function o(t){return t*(Math.PI/180)}$("#datepicker").datepicker(),$("#datepicker").datepicker("setDate","0");var n=0;setInterval(function(){n+=.1;var t=parseFloat($("#turbidity").val()),a=o(parseFloat($("#longitude").val())),h=o(parseFloat($("#latitude").val())),f=o(15*parseFloat($("#tz_sm").val())),i=$("#datepicker").datepicker("getDate"),c=(Math.floor(f/o(15)+.5),function(t){var a=t-new Date(t.getFullYear(),0,0);return Math.floor(a/864e5)}(i)),M=n%24,s=Math.floor(M)+":"+Math.floor(60*(M-Math.floor(M)));$("#curtime").val(s);var l=M+.17*Math.sin(4*Math.PI*(c-80)/373)-.129*Math.sin(2*Math.PI*(c-8)/355)+12*(f-a)/Math.PI,u=.4093*Math.sin(2*Math.PI*(c-81)/368),g=Math.sin(h),d=Math.cos(h),v=Math.sin(u),b=Math.cos(u),m=Math.cos(Math.PI*l/12),p=Math.sin(Math.PI*l/12),I=Math.PI/2-Math.asin(g*v-d*b*m),x=Math.atan2(-b*p,d*v-g*b*m);zen_abs=function(t,a){var e={},r=(4.0453*t-4.971)*Math.tan((4/9-t/120)*(Math.PI-2*a))-.2155*t+2.4192;Y0=40,e.Yz=r/Y0;var o=Math.pow(a,3),n=Math.pow(a,2),h=a,f=[t*t,t,1],i=[.00166*o-.00375*n+.00209*h+0,-.02903*o+.06377*n-.03202*h+.00394,.11693*o-.21196*n+.06052*h+.25886];e.xz=f[0]*i[0]+f[1]*i[1]+f[2]*i[2];var c=[.00275*o-.0061*n+.00317*h+0,-.04214*o+.0897*n-.04153*h+.00516,.15346*o-.26756*n+.0667*h+.26688];return e.yz=f[0]*c[0]+f[1]*c[1]+f[2]*c[2],e}(t,I),coeffs_mtx=function(t){var a={},e={};e.A=.1787*t-1.463,e.B=-.3554*t+.4275,e.C=-.0227*t+5.3251,e.D=.1206*t-2.5771,e.E=-.067*t+.3703,a.coeffsY=e;var r={};r.A=-.0193*t-.2592,r.B=-.0665*t+8e-4,r.C=-4e-4*t+.2125,r.D=-.0641*t-.8989,r.E=-.0033*t+.0452,a.coeffsx=r;var o={};return o.A=-.0167*t-.2608,o.B=-.095*t+.0092,o.C=-.0079*t+.2102,o.D=-.0441*t-1.6537,o.E=-.0109*t+.0529,a.coeffsy=o,a}(t);var y=document.getElementById("sky"),z=document.getElementById("avg-color");y.style.filter="blur(3px) saturate(200%)";var P,w,k,C=y.getContext("2d"),D=y.width,Y=y.height,E=function(t){var a,e,r,o,n={r:0,g:0,b:0},h=document.createElement("canvas"),f=h.getContext&&h.getContext("2d"),i=-4,c={r:0,g:0,b:0},M=0;if(!f)return n;r=h.height=t.naturalHeight||t.offsetHeight||t.height,e=h.width=t.naturalWidth||t.offsetWidth||t.width,f.drawImage(t,0,0);try{a=f.getImageData(0,0,e,r)}catch(t){return n}for(o=a.data.length;(i+=20)<o;)++M,c.r+=a.data[i],c.g+=a.data[i+1],c.b+=a.data[i+2];return c.r=~~(c.r/M),c.g=~~(c.g/M),c.b=~~(c.b/M),c}(y);console.log(`rgb(${E.r},${E.g},${E.b})`),z.value=`rgb(${E.r},${E.g},${E.b})`,z.style.backgroundColor=`rgb(${E.r},${E.g},${E.b})`;for(var B=0;B<1;B+=.025)for(var F=0;F<1;F+=1/60){azimuth=o(r(F,0,1,-180,180)),zenith=o(r(B,0,1,0,90));var _=e(zenith,azimuth,zen_abs,I,x,coeffs_mtx);C.fillStyle=(P=_.r,w=_.g,k=_.b,"rgb("+Math.floor(255*P)+","+Math.floor(255*w)+","+Math.floor(255*k)+")");var A=B*Y,H=F*D;C.fillRect(H,A,D/60,Y/40)}},50)});