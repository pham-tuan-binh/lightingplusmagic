$(document).ready(function(){function t(t,a,e){return(1+e.A*Math.exp(e.B/Math.cos(t)))*(1+e.C*Math.exp(e.D*a)+e.E*Math.pow(Math.cos(a),2))}function a(t){return Math.max(Math.min(Math.pow(t,1/1.8),1),0)}function e(e,r,o,n,h,i){var f=function(t,a,e,r){return Math.acos(Math.sin(e)*Math.sin(t)*Math.cos(a-r)+Math.cos(e)*Math.cos(t))}(e,r,n,h);e=Math.min(e,Math.PI/2);var s,c,l,M,u,d=o.Yz*t(e,f,i.coeffsY)/t(0,n,i.coeffsY),g=o.xz*t(e,f,i.coeffsx)/t(0,n,i.coeffsx),v=o.yz*t(e,f,i.coeffsy)/t(0,n,i.coeffsy);return{r:a(3.2406*(M=(c=g)/(l=v)*(s=d))-1.5372*s-.4986*(u=(1-c-l)/l*s)),g:a(-.9689*M+1.8758*s+.0415*u),b:a(.0557*M-.204*s+1.057*u)}}function r(t,a,e,r,o){return(t-a)/(e-a)*(o-r)+r}function o(t){return t*(Math.PI/180)}$("#datepicker").datepicker(),$("#datepicker").datepicker("setDate","0");var n=0;setInterval(function(){n+=.25;var t=parseFloat($("#turbidity").val()),a=o(parseFloat($("#longitude").val())),h=o(parseFloat($("#latitude").val())),i=o(parseFloat($("#tz_sm").val())),f=$("#datepicker").datepicker("getDate"),s=(Math.floor(i/o(15)+.5),function(t){var a=t-new Date(t.getFullYear(),0,0);return Math.floor(a/864e5)}(f));total_hours_today=n%24,time_str=Math.floor(total_hours_today)+":"+Math.floor(60*(total_hours_today-Math.floor(total_hours_today))),$("#curtime").val(time_str);var c=total_hours_today+.17*Math.sin(4*Math.PI*(s-80)/373)-.129*Math.sin(2*Math.PI*(s-8)/355)+12*(i-a)/Math.PI,l=.4093*Math.sin(2*Math.PI*(s-81)/368),M=Math.sin(h),u=Math.cos(h),d=Math.sin(l),g=Math.cos(l),v=Math.cos(Math.PI*c/12),m=Math.sin(Math.PI*c/12),b=Math.PI/2-Math.asin(M*d-u*g*v),y=Math.atan2(-g*m,u*d-M*g*v);zen_abs=function(t,a){var e={},r=(4.0453*t-4.971)*Math.tan((4/9-t/120)*(Math.PI-2*a))-.2155*t+2.4192;Y0=40,e.Yz=r/Y0;var o=Math.pow(a,3),n=Math.pow(a,2),h=a,i=[t*t,t,1],f=[.00166*o-.00375*n+.00209*h+0,-.02903*o+.06377*n-.03202*h+.00394,.11693*o-.21196*n+.06052*h+.25886];e.xz=i[0]*f[0]+i[1]*f[1]+i[2]*f[2];var s=[.00275*o-.0061*n+.00317*h+0,-.04214*o+.0897*n-.04153*h+.00516,.15346*o-.26756*n+.0667*h+.26688];return e.yz=i[0]*s[0]+i[1]*s[1]+i[2]*s[2],e}(t,b),coeffs_mtx=function(t){var a={},e={};e.A=.1787*t-1.463,e.B=-.3554*t+.4275,e.C=-.0227*t+5.3251,e.D=.1206*t-2.5771,e.E=-.067*t+.3703,a.coeffsY=e;var r={};r.A=-.0193*t-.2592,r.B=-.0665*t+8e-4,r.C=-4e-4*t+.2125,r.D=-.0641*t-.8989,r.E=-.0033*t+.0452,a.coeffsx=r;var o={};return o.A=-.0167*t-.2608,o.B=-.095*t+.0092,o.C=-.0079*t+.2102,o.D=-.0441*t-1.6537,o.E=-.0109*t+.0529,a.coeffsy=o,a}(t);var p=document.getElementById("sky"),_=document.getElementById("avg-color");p.style.filter="blur(3px) saturate(150%)";var I,x,z,P=p.getContext("2d"),w=p.width,k=p.height,C=function(t){var a,e,r,o,n={r:0,g:0,b:0},h=document.createElement("canvas"),i=h.getContext&&h.getContext("2d"),f=-4,s={r:0,g:0,b:0},c=0;if(!i)return n;r=h.height=t.naturalHeight||t.offsetHeight||t.height,e=h.width=t.naturalWidth||t.offsetWidth||t.width,i.drawImage(t,0,0);try{a=i.getImageData(0,0,e,r)}catch(t){return n}for(o=a.data.length;(f+=20)<o;)++c,s.r+=a.data[f],s.g+=a.data[f+1],s.b+=a.data[f+2];return s.r=~~(s.r/c),s.g=~~(s.g/c),s.b=~~(s.b/c),s}(p);console.log(`rgb(${C.r},${C.g},${C.b})`),_.value=`rgb(${C.r},${C.g},${C.b})`,_.style.backgroundColor=`rgb(${C.r},${C.g},${C.b})`;for(var D=0;D<1;D+=1/240)for(var Y=0;Y<1;Y+=1/640){azimuth=o(r(Y,0,1,-180,180)),zenith=o(r(D,0,1,0,90));var E=e(zenith,azimuth,zen_abs,b,y,coeffs_mtx);P.fillStyle=(I=E.r,x=E.g,z=E.b,"rgb("+Math.floor(255*I)+","+Math.floor(255*x)+","+Math.floor(255*z)+")");var B=D*k,F=Y*w;P.fillRect(F,B,w/640,k/240)}},100)});