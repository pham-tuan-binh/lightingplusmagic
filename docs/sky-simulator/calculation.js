$(document).ready(()=>{function t(t,a){let e={},o=(4.0453*t-4.971)*Math.tan((4/9-t/120)*(Math.PI-2*a))-.2155*t+2.4192,l=(4.0453*t-4.971)*Math.tan((4/9-t/120)*Math.PI)-.2155*t+2.4192;e.Yz=o/l;let r=Math.pow(a,3),h=Math.pow(a,2),n=a,i=[t*t,t,1],M=[.00166*r-.00375*h+.00209*n+0,-.02903*r+.06377*h-.03202*n+.00394,.11693*r-.21196*h+.06052*n+.25886];e.xz=i[0]*M[0]+i[1]*M[1]+i[2]*M[2];let s=[.00275*r-.0061*h+.00317*n+0,-.04214*r+.0897*h-.04153*n+.00516,.15346*r-.26756*h+.0667*n+.26688];return e.yz=i[0]*s[0]+i[1]*s[1]+i[2]*s[2],e}function a(t){let a={},e={};e.A=.1787*t-1.463,e.B=-.3554*t+.4275,e.C=-.0227*t+5.3251,e.D=.1206*t-2.5771,e.E=-.067*t+.3703,a.coeffsY=e;let o={};o.A=-.0193*t-.2592,o.B=-.0665*t+8e-4,o.C=-4e-4*t+.2125,o.D=-.0641*t-.8989,o.E=-.0033*t+.0452,a.coeffsx=o;let l={};return l.A=-.0167*t-.2608,l.B=-.095*t+.0092,l.C=-.0079*t+.2102,l.D=-.0441*t-1.6537,l.E=-.0109*t+.0529,a.coeffsy=l,a}function e(t,a,e){return(1+e.A*Math.exp(e.B/Math.cos(t)))*(1+e.C*Math.exp(e.D*a)+e.E*Math.pow(Math.cos(a),2))}function o(t){return Math.max(Math.min(Math.pow(t,1/1.8),1),0)}function l(t,a,l,r,h,n){let i=function(t,a,e,o){return Math.acos(Math.sin(e)*Math.sin(t)*Math.cos(a-o)+Math.cos(e)*Math.cos(t))}(t,a,r,h);return t=Math.min(t,Math.PI/2),function(t,a,e){let l=a*(t/e),r=t/e*(1-a-e);return{r:o(3.2406*l-1.5372*t-.4986*r)||"0",g:o(-.9689*l+1.8758*t+.0415*r)||"0",b:o(.0557*l-.204*t+1.057*r)||"0"}}(l.Yz*e(t,i,n.coeffsY)/e(0,r,n.coeffsY),l.xz*e(t,i,n.coeffsx)/e(0,r,n.coeffsx),l.yz*e(t,i,n.coeffsy)/e(0,r,n.coeffsy))}function r(t,a,e,o,l){return(t-a)/(e-a)*(l-o)+o}function h(t){return t*(Math.PI/180)}function n(t){let a=t-new Date(t.getFullYear(),0,0);return Math.floor(a/864e5)}function i(e){let o=parseFloat($("#turbidity").val()),r=h(parseFloat($("#longitude").val())),i=h(parseFloat($("#latitude").val())),M=h(15*parseFloat($("#tz_sm").val())),s=n($("#datepicker").datepicker("getDate")),f=e%24,c=(Math.floor(f)<10?"0"+Math.floor(f):Math.floor(f))+":"+Math.floor(60*(f-Math.floor(f)));$("#curtime").val(c);let u=f+.17*Math.sin(4*Math.PI*(s-80)/373)-.129*Math.sin(2*Math.PI*(s-8)/355)+12*(M-r)/Math.PI,d=.4093*Math.sin(2*Math.PI*(s-81)/368),p=Math.sin(i),g=Math.cos(i),m=Math.sin(d),v=Math.cos(d),b=Math.cos(Math.PI*u/12),z=Math.sin(Math.PI*u/12),I=Math.PI/2-Math.asin(p*m-g*v*b),y=Math.atan2(-v*z,g*m-p*v*b);zen_abs=t(o,I),coeffs_mtx=a(o),azimuth=h(-180),zenith=h(0);let P=l(zenith,azimuth,zen_abs,I,y,coeffs_mtx);return[Math.floor(255*P.r),Math.floor(255*P.g),Math.floor(255*P.b)]}let M=0;onmessage=function(e){switch(e.data){case"render":(function(e){function o([t,a,e]){w.value=`rgb(${t},${a},${e})`,w.style.backgroundColor=`rgb(${t},${a},${e})`}let M=parseFloat($("#turbidity").val()),s=h(parseFloat($("#longitude").val())),f=h(parseFloat($("#latitude").val())),c=h(15*parseFloat($("#tz_sm").val())),u=n($("#datepicker").datepicker("getDate")),d=e%24,p=(Math.floor(d)<10?"0"+Math.floor(d):Math.floor(d))+":"+Math.floor(60*(d-Math.floor(d)));$("#curtime").val(p);let g=d+.17*Math.sin(4*Math.PI*(u-80)/373)-.129*Math.sin(2*Math.PI*(u-8)/355)+12*(c-s)/Math.PI,m=.4093*Math.sin(2*Math.PI*(u-81)/368),v=Math.sin(f),b=Math.cos(f),z=Math.sin(m),I=Math.cos(m),y=Math.cos(Math.PI*g/12),P=Math.sin(Math.PI*g/12),x=Math.PI/2-Math.asin(v*z-b*I*y),F=Math.atan2(-I*P,b*z-v*I*y);zen_abs=t(M,x),coeffs_mtx=a(M);let k=document.getElementById("sky"),w=document.getElementById("avg-color");k.style.filter="blur(3px)";let _=k.getContext("2d"),C=k.width,D=k.height;for(let t=0;t<1;t+=.025)for(let a=0;a<1;a+=1/60){azimuth=h(r(a,0,1,-180,180)),zenith=h(r(t,0,1,0,90));let e=l(zenith,azimuth,zen_abs,x,F,coeffs_mtx);_.fillStyle=(B=e.r,E=e.g,Y=e.b,"rgb("+Math.floor(255*B)+","+Math.floor(255*E)+","+Math.floor(255*Y)+")");let o=t*D,n=a*C;_.fillRect(n,o,C/60,D/40)}var B,E,Y;k.toBlob(function(t){var a=document.createElement("img"),e=URL.createObjectURL(t);a.onload=function(){URL.revokeObjectURL(e)},a.src=e,a.width=k.width,a.height=k.height;var l=new ColorThief;a.complete?o(l.getColor(a)):a.addEventListener("load",function(){o(l.getColor(a))})}),i(e)})(M+=.02);break;case"data":!function(){let t={turbidity:parseFloat($("#turbidity").val()),longitude:h(parseFloat($("#longitude").val())),latitude:h(parseFloat($("#latitude").val())),timeZone:h(15*parseFloat($("#tz_sm").val())),date:$("#datepicker").datepicker("getDate"),data:[]};for(let a=0;a<24;a+=1.5){let e=(Math.floor(a)<10?"0"+Math.floor(a):Math.floor(a))+":"+(Math.floor(60*(a-Math.floor(a)))<10?"0"+Math.floor(60*(a-Math.floor(a))):Math.floor(60*(a-Math.floor(a))));t.data.push({time:e,color:i(a)})}var a=new Blob([JSON.stringify(t,null,2)],{type:"application/json;charset=utf-8"});saveAs(a,(Math.random().toString(36)+"00000000000000000").slice(2,10)+".solarpreset")}()}},setInterval(()=>{postMessage("render")},10),$("#exportData").click(()=>{postMessage("data")})});